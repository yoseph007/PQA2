"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[8266],{1804:function(t,e,n){n.d(e,{o:function(){return u}});var i=n(27573),s=n(8571),o=n(27218),a=n(88146),r=n(45790);let l=()=>{let t=(0,s.Z)(),{websiteBaseUrl:e}=(0,s.m)();return t?(0,i.jsx)(r.Z,{defaultMessage:"Or consider <link>upgrading to Claude Pro</link>.",id:"j0jOXOpUyS",values:{link:t=>(0,i.jsx)("a",{href:"/upgrade/pro",className:"font-bold underline",rel:"noreferrer",children:t})}}):(0,i.jsx)(r.Z,{defaultMessage:"Or <link>contact sales</link> if you would be interested in upgrading to a paid version of Claude.",id:"3hk4yMCf5v",values:{link:t=>(0,i.jsx)(a.default,{href:"".concat(e,"/contact-sales"),className:"font-bold underline",children:t})}})};function u(){let t=(0,o.w7)(),e=(0,o.uh)();return t&&!e?(0,i.jsx)(l,{}):null}},28266:function(t,e,n){n.d(e,{hH:function(){return Y},wN:function(){return $},Qk:function(){return tt},pV:function(){return G},lE:function(){return X}});var i,s,o,a,r=n(27573),l=n(96933),u=n(1804),c=n(3053),d=n(8571),h=n(27218),p=n(27895),_=n(66092),m=n(30947),g=n(6385),f=n(66894),k=n(14448),v=n(13262),y=n(91598),x=n(51432),b=n(45144),C=n(77930),w=n(5068),S=n(13784),j=n(88146),E=n(81695),M=n(7653),T=n(45790),O=n(15992),L=n(8073);let I=1e3/60;class N{_getCurrentTextBlockCharCount(){let t=this.completionsToSmooth[this.completionsToSmooth.length-1];return"text"===t.type?[...t.text].length:0}_getBlockCharCount(t){var e,n,i;return"text"===t.type?t.text.length:"thinking"===t.type?t.thinking.length:"redacted_thinking"===t.type?t.data.length:"tool_use"===t.type?(null===(e=t.partial_json)||void 0===e?void 0:e.length)||0:"tool_result"===t.type?0:"bell"===t.type?((null===(n=t.text)||void 0===n?void 0:n.length)||0)+((null===(i=t.title)||void 0===i?void 0:i.length)||0):0}_maybeConvertMessageEventToContentBlock(t){let e=this.completionsToSmooth[this.completionsToSmooth.length-1];switch(t.type){case"content_block_delta":if("text_delta"===t.delta.type)return{type:"text",text:t.delta.text,citations:[]};if("input_json_delta"===t.delta.type){if(e&&"tool_use"===e.type)return{type:"tool_use",id:"",name:"",partial_json:t.delta.partial_json};if(e&&"tool_result"===e.type)return{type:"tool_result",tool_use_id:"",name:"",is_error:!1,content:[{type:"text",text:t.delta.partial_json}]}}if("citation_start_delta"===t.delta.type){this.pendingCitations[t.delta.citation.uuid]={...t.delta.citation,start_index:this._getCurrentTextBlockCharCount()};return}if("citation_end_delta"===t.delta.type)return{type:"text",text:"",citations:[{...this.pendingCitations[t.delta.citation_uuid],end_index:this._getCurrentTextBlockCharCount()}]};if("thinking_cut_off_delta"===t.delta.type)return{type:"thinking",thinking:"",start_timestamp:"",cut_off:t.delta.cut_off};if("thinking_delta"===t.delta.type)return{type:"thinking",thinking:t.delta.thinking,start_timestamp:t.delta.start_timestamp,stop_timestamp:t.delta.stop_timestamp};if("signature_delta"===t.delta.type)return{type:"thinking",thinking:"",signature:t.delta.signature,start_timestamp:""};break;case"content_block_start":return"thinking"===t.content_block.type&&(t.content_block.start_timestamp=new Date().toISOString()),t.content_block;case"content_block_stop":if((null==e?void 0:e.type)==="thinking")return{type:"thinking",thinking:"",start_timestamp:e.start_timestamp||"",stop_timestamp:t.stop_timestamp,signature:e.signature,cut_off:e.cut_off};if((null==e?void 0:e.type)==="redacted_thinking")return{type:"redacted_thinking",data:"",start_timestamp:e.start_timestamp||"",stop_timestamp:t.stop_timestamp}}}_set_raw_completion(t){if(0===this.start&&(this.start=Date.now()),"content_block_delta"===t.type&&"thinking_summary_delta"===t.delta.type){let e=this.completionsToSmooth.findLast(t=>"thinking"===t.type);e&&(e.summaries=[...e.summaries||[],t.delta.summary])}else{let e=this._maybeConvertMessageEventToContentBlock(t);e&&(t=>{if(0===this.completionsToSmooth.length){this.completionsToSmooth.push(t);return}let e=this.completionsToSmooth[this.completionsToSmooth.length-1];if(e.type!==t.type||"tool_use"===t.type&&t.id||"tool_result"===t.type&&t.tool_use_id){this.completionsToSmooth.push(t);return}switch(t.type){case"text":this.is_inside_paprika=!1,e.type===t.type&&(e.text+=t.text,(e.citations||t.citations)&&(e.citations=(e.citations||[]).concat(t.citations||[])));break;case"thinking":if(this.is_inside_paprika=!0,"thinking"===e.type){e.thinking+=t.thinking,e.cut_off=t.cut_off;let n=t.signature||"";e.signature=(e.signature||"")+n,t.stop_timestamp&&(e.stop_timestamp=t.stop_timestamp)}break;case"redacted_thinking":this.is_inside_paprika=!0,"redacted_thinking"===e.type&&(e.data+=t.data,t.stop_timestamp&&(e.stop_timestamp=t.stop_timestamp));break;case"tool_use":if(this.is_inside_paprika=!1,"tool_use"===e.type){var n,i;e.partial_json=(null!==(n=e.partial_json)&&void 0!==n?n:"")+(null!==(i=t.partial_json)&&void 0!==i?i:"")}break;case"tool_result":this.is_inside_paprika=!1,"tool_result"===e.type&&(e.content=t.content);break;case"bell":this.is_inside_paprika=!1,"bell"===e.type&&(e.text+=t.text||"",e.title+=t.title||"");break;default:this.is_inside_paprika=!1}})(e)}this.model_done="message_stop"===t.type;let e=this.completionsToSmooth.reduce((t,e)=>t+this._getBlockCharCount(e),0);if(this.totalCompletionLength=e,this.arrivals.push([(Date.now()-this.start)/1e3,e]),this.dont_smooth&&this.on_completion){let t=structuredClone(this.completionsToSmooth),e=t[t.length-1];e&&"tool_result"===e.type&&0===e.content.length||this.on_completion(t)}}_get_smoothed_completion(){if(0===this.start)return[];let t=(Date.now()-this.start)/1e3,e=this.arrivals[this.arrivals.length-1][1]+(this.model_done?100:0),n=.9*t-(this.is_inside_paprika?3:.3),i=this.arrivals.filter(t=>t[0]<n).map(t=>t[1]),s=i[i.length-1],o=function(t,e,n){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:.01;if(e===n)return e;let s=t(e),o=t(n);if(e>=n)throw Error("Lower x is greater than upper x");if(s>i)throw Error("Lower f is greater than zero");if(o<-i)throw Error("Upper f is less than zero");for(;s<-i;){let i=(e+n)/2,a=t(i);a<=0?(e=i,s=a):(n=i,o=a)}return e}(n=>{let i=(n-this.x)/(t-this.t),o=1/(t-this.t);return 2*this.gamma*o*(i-this.v)-1/(n-s)+1/(e-n)},s,e),a=(o-this.x)/(t-this.t);this.v=this.alpha*this.v+(1-this.alpha)*a,this.smoothed_completion_is_unchanged=this.x>=this.totalCompletionLength,this.x=Math.max(o,this.x),this.t=t,this.smoother_done=this.model_done&&this.x>=this.totalCompletionLength,this.stats.push({t,x:o,v:a,min_chars:s,max_chars:e});let r=(t,e)=>{var n,i;return"tool_result"===t.type?t:"text"===t.type?{...t,text:t.text.slice(0,e)}:"tool_use"===t.type?{...t,partial_json:null===(n=t.partial_json)||void 0===n?void 0:n.slice(0,e)}:"thinking"===t.type?{...t,thinking:t.thinking.slice(0,e)}:"redacted_thinking"===t.type?{...t,data:t.data.slice(0,e)}:"bell"===t.type?{...t,text:(null===(i=t.text)||void 0===i?void 0:i.slice(0,e))||""}:t},l=0,u=[];for(let t of this.completionsToSmooth){let e=this._getBlockCharCount(t);if(l+e<this.x)u.push(t),l+=e;else{let e=r(t,this.x-l);u.push(e);break}}return u}getTextCompletion(){let t=this.completionsToSmooth.find(t=>"text"===t.type);return t&&t.text||""}onMessage(t){this._set_raw_completion(t)}async task(t,e){for(;!this.smoother_done&&!e.aborted;){if(this.completionsToSmooth.length>0){let e=this._get_smoothed_completion();this.smoothed_completion_is_unchanged||t(e)}await new Promise(t=>setTimeout(t,I))}}constructor(t){var e;this.alpha=.99,this.gamma=1e-5,this.v=100,this.x=0,this.t=0,this.arrivals=[[-9999,0]],this.start=0,this.completionsToSmooth=[],this.totalCompletionLength=0,this.smoothed_completion_is_unchanged=!1,this.pendingCitations={},this.dont_smooth=!1,this.model_done=!1,this.smoother_done=!1,this.is_inside_paprika=!1,this.stats=[],this.redactedStrings=null!==(e=null==t?void 0:t.redactedStrings)&&void 0!==e?e:{}}}var D=n(58884);let P=(t,e)=>e.reduce((e,n)=>e+t.blockSize(n),0),B=(t,e,n)=>{let{blockSize:i,sliceBlock:s}=t,o=[];if(n<=0)return[];let a=0;for(let t of e){if(a+i(t)>=n){o.push(s(t,n-a));break}o.push(t),a+=i(t)}return o},z=1e3/60;class R{_get_smoothed_completion(){var t,e,n;if(0===this.start)return[];let i=(Date.now()-this.start)/1e3,s=this.arrivals[this.arrivals.length-1][1]+(this.model_done?100:0),o=.9*i-(null!==(n=null===(t=(e=this.blockOperations).getBlockDeadlineOffset)||void 0===t?void 0:t.call(e))&&void 0!==n?n:.3),a=this.arrivals.filter(t=>t[0]<o).map(t=>t[1]),r=a[a.length-1],l=function(t,e,n){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:.01;if(e===n)return e;let s=t(e),o=t(n);if(e>=n)throw Error("Lower x is greater than upper x");if(s>i)throw Error("Lower f is greater than zero");if(o<-i)throw Error("Upper f is less than zero");for(;s<-i;){let i=(e+n)/2,a=t(i);a<=0?(e=i,s=a):(n=i,o=a)}return e}(t=>{let e=(t-this.x)/(i-this.t),n=1/(i-this.t);return 2*this.gamma*n*(e-this.v)-1/(t-r)+1/(s-t)},r,s),u=(l-this.x)/(i-this.t);return this.v=this.alpha*this.v+(1-this.alpha)*u,this.smoothed_completion_is_unchanged=this.x>=this.totalCompletionLength,this.x=Math.max(l,this.x),this.t=i,this.smoother_done=this.model_done&&this.x>=this.totalCompletionLength,this.stats.push({t:i,x:l,v:u,min_chars:r,max_chars:s}),B(this.blockOperations,this.blocksList,this.x)}addBlock(t,e){this.blocksList.push(e)}updateBlock(t,e){this.blocksList[t]=e}getBlocks(){return this.blocksList}onMessage(t){switch(t.type){case"content_block_start":{let e=this.blockOperations.createBlockFromStartEvent(t);null!==e&&this.addBlock(t.index,e);break}case"content_block_delta":{let e=this.blocksList[t.index];if(!e)break;let n=this.blockOperations.applyDeltaEvent(t,e);this.updateBlock(t.index,n);break}case"content_block_stop":{let e=this.blocksList[t.index];if(!e)break;let n=this.blockOperations.stopBlockEvent(t,e);this.updateBlock(t.index,n);break}case"message_stop":this.model_done=!0}0===this.start&&(this.start=Date.now());let e=P(this.blockOperations,this.blocksList);if(this.totalCompletionLength=e,this.arrivals.push([(Date.now()-this.start)/1e3,e]),this.dont_smooth&&this.on_completion){let t=structuredClone(this.blocksList);this.on_completion(t)}}async task(t,e){for(;!this.smoother_done&&!e.aborted;){if(this.blocksList.length>0){let e=this._get_smoothed_completion();this.smoothed_completion_is_unchanged||t(e)}await new Promise(t=>setTimeout(t,z))}}constructor(t){this.alpha=.99,this.gamma=1e-5,this.v=100,this.x=0,this.t=0,this.arrivals=[[-9999,0]],this.start=0,this.totalCompletionLength=0,this.smoothed_completion_is_unchanged=!1,this.dont_smooth=!1,this.model_done=!1,this.smoother_done=!1,this.stats=[],this.blocksList=[],this.blockOperations=t}}(i=o||(o={}))[i.APPEND_MESSAGE_WITH_COMPLETION=1]="APPEND_MESSAGE_WITH_COMPLETION",i[i.RETRY_MESSAGE_WITH_COMPLETION=2]="RETRY_MESSAGE_WITH_COMPLETION",(s=a||(a={})).Ping="ping",s.Completion="completion",s.Error="error",s.ContentBlockDelta="content_block_delta",s.ContentBlockStart="content_block_start",s.ContentBlockStop="content_block_stop",s.MessageDelta="message_delta",s.MessageStart="message_start",s.MessageStop="message_stop",s.MessageLimit="message_limit";let H=["close_file","create_file","delete_file","draw_svg","file_search","open_file","repl","str_replace","update_file"];async function Q(t){let e,n,{applicationType:i,endpoint:s,orgUuid:o,conversationUuid:a,body:r,onCompletion:l,onInvokeTool:u,abortController:c,completion:d,getTools:h,smoothingEnabled:p=!0,shouldUseNewSmoother:_,redactedStrings:g}=t,f=_?(e={},n=!1,new R({blockSize:t=>{if("text"===t.type)return t.text.length;if("thinking"===t.type)return t.thinking.length;if("tool_use"===t.type){var e;return(null===(e=t.partial_json)||void 0===e?void 0:e.length)||0}return t.type,0},sliceBlock:(t,e)=>{if("tool_result"===t.type)return t;if("text"===t.type)return{...t,text:t.text.slice(0,e)};if("tool_use"===t.type){var n;return{...t,partial_json:null===(n=t.partial_json)||void 0===n?void 0:n.slice(0,e)}}return"thinking"===t.type?{...t,thinking:t.thinking.slice(0,e)}:t},createBlockFromStartEvent:t=>("thinking"===t.content_block.type&&(t.content_block.start_timestamp=new Date().toISOString()),t.content_block),applyDeltaEvent:(t,i)=>{var s,o;switch(i.type){case"text":switch(n=!1,t.delta.type){case"text_delta":return{...i,text:i.text+t.delta.text};case"citation_start_delta":{let n=t.delta.citation;return e={...e,[n.uuid]:{...n,start_index:i.text.length}},i}case"citation_end_delta":{let n=t.delta.citation_uuid;return{...i,citations:(null!==(s=i.citations)&&void 0!==s?s:[]).concat({...e[n],end_index:i.text.length})}}default:return i}case"thinking":switch(n=!0,t.delta.type){case"thinking_delta":return{...i,thinking:i.thinking+t.delta.thinking};case"thinking_summary_delta":return{...i,summaries:[...i.summaries||[],t.delta.summary]};case"thinking_cut_off_delta":return{...i,cut_off:t.delta.cut_off};default:return i}case"tool_result":if(n=!1,"input_json_delta"===t.delta.type)return{type:"tool_result",tool_use_id:"",name:"",is_error:!1,content:[{type:"text",text:t.delta.partial_json}]};return i;case"tool_use":if(n=!1,"input_json_delta"===t.delta.type)return{...i,partial_json:(null!==(o=i.partial_json)&&void 0!==o?o:"")+t.delta.partial_json};return i}},stopBlockEvent:(t,e)=>"thinking"===e.type?{...e,stop_timestamp:t.stop_timestamp}:e,getBlockDeadlineOffset(){if(n)return 3}})):new N({redactedStrings:g});f.dont_smooth=!p,f.on_completion=l;let k=p?f.task(l,c.signal):Promise.resolve(),v={"Content-Type":"application/json",Accept:"text/event-stream",...(0,L.F)(i)},y=null,x=null,C=JSON.stringify({...d,...r,text:void 0,rendering_mode:"messages",organization_uuid:void 0,conversation_uuid:void 0}),w="",S="",j="",E=0,M=(0,D.L)(function(t,e,n){let i;if(void 0===e||void 0===n)throw Error("Missing org uuid or conversation uuid");switch(t){case 1:i="completion";break;case 2:i="retry_completion";break;default:throw Error("Invalid endpoint")}return"/api/organizations/".concat(e,"/chat_conversations/").concat(n,"/").concat(i)}(s,o,a),{method:"POST",credentials:"include",headers:v,body:C,openWhenHidden:!0,signal:c.signal,async onopen(t){var e;if(!t.ok||!(null===(e=t.headers.get("content-type"))||void 0===e?void 0:e.includes(D.a))){let e=await t.text(),n={};try{n=JSON.parse(e)}catch(t){}throw(0,m.fT)(t.status,n,"Failed to fetch",t.headers)}},onmessage:_?t=>{var e,n;switch(t.event){case"ping":default:return;case"completion":{let n=JSON.parse(t.data);if(void 0===n.completion)throw Error("Unexpected message received when streaming: ".concat(t.data));let i={type:"content_block_delta",index:0,delta:{type:"text_delta",text:n.completion}};y=n.stop_reason,x=null!==(e=n.messageLimit)&&void 0!==e?e:null,f.onMessage(i);break}case"content_block_start":{let e=JSON.parse(t.data);E=e.index,"tool_use"===e.content_block.type&&(S=e.content_block.name,j=e.content_block.id),f.onMessage(e);break}case"content_block_delta":{let e=JSON.parse(t.data);if(e.index!==E&&"thinking_summary_delta"!==e.delta.type)throw Error("Content block index did not match the expected index");(null===(n=e.delta)||void 0===n?void 0:n.type)==="input_json_delta"&&(H.includes(S)||h().some(t=>t.name===S))&&(w+=e.delta.partial_json),f.onMessage(e);break}case"content_block_stop":{let e=JSON.parse(t.data);if(e.index!==E)throw Error("Content block index did not match the expected index");if(f.onMessage(e),!S)break;u(a,S,j,w),w="",S="",j="";break}case"message_limit":x=JSON.parse(t.data).message_limit;break;case"message_delta":case"message_start":case"message_stop":{let e=JSON.parse(t.data);"message_stop"===e.type&&(y="message_stop"),f.onMessage(e)}}}:t=>{var e,n;switch(t.event){case"ping":default:return;case"error":throw(0,m.fT)(0,JSON.parse(t.data),"Streaming error: 22");case"completion":{let n=JSON.parse(t.data);if(void 0===n.completion)throw Error("Unexpected message received when streaming: ".concat(t.data));let i={type:"content_block_delta",index:0,delta:{type:"text_delta",text:n.completion}};y=n.stop_reason,x=null!==(e=n.messageLimit)&&void 0!==e?e:null,f.onMessage(i);break}case"content_block_start":{let e=JSON.parse(t.data);E=e.index,"tool_use"===e.content_block.type&&(S=e.content_block.name,j=e.content_block.id),f.onMessage(e);break}case"content_block_delta":{let e=JSON.parse(t.data);if(e.index!==E&&"thinking_summary_delta"!==e.delta.type)throw Error("Content block index did not match the expected index");(null===(n=e.delta)||void 0===n?void 0:n.type)==="input_json_delta"&&(H.includes(S)||h().some(t=>t.name===S))&&(w+=e.delta.partial_json),f.onMessage(e);break}case"content_block_stop":{let e=JSON.parse(t.data);if(e.index!==E)throw Error("Content block index did not match the expected index");if(f.onMessage(e),!S)break;u(a,S,j,w),w="",S="",j="";break}case"message_delta":case"message_start":case"message_stop":case"message_limit":{let e=JSON.parse(t.data);"message_stop"===e.type&&(y="message_stop"),"message_limit"===e.type&&(x=e.message_limit),f.onMessage(e)}}},onclose(){f.model_done=!0},onerror(t){throw t instanceof m.Hx&&529===t.statusCode||(0,b.Tb)(t),f.model_done=!0,f.smoother_done=!0,t}});return await Promise.all([M,k]),{stopReason:y,messageLimitResult:x}}var Z=n(1146),J=n(77879),A=n(78230),W=n(49185),F=n(57271);let U=(0,M.createContext)([null,null]);function Y(t){let{children:e}=t,n=(0,M.useState)({});return(0,r.jsx)(U.Provider,{value:n,children:e})}function G(t,e,n){let{onIncrementalCompletion:i,onStartAppend:s,onStreamCompleted:a}=(0,F.p)(),r=te({conversationUUID:t,endpoint:o.APPEND_MESSAGE_WITH_COMPLETION,onIncrementalCompletion:i,onStreamCompleted:a,onInvokeTool:e,getTools:n}),{runStream:l}=r,u=(0,M.useCallback)(async e=>{let{prompt:n,attachments:i,files:o,syncSources:a,rethrowErrors:r=!1,modelOverride:u,parent_message_uuid:c,personalized_style:d}=e;await s(t,t=>{if(!t)throw Error("Conversation tree must be provided for tree append");let e=(0,Z.HX)(t),s=[{uuid:Z.wZ,content:[{type:"text",text:n,citations:[]}],created_at:new Date().toISOString(),sender:"human",attachments:i,files:o,files_v2:o,sync_sources:a,index:e+1,parent_message_uuid:null!=c?c:Z.QC},{uuid:Z.FC,content:[],created_at:new Date().toISOString(),sender:"assistant",attachments:[],files:[],files_v2:[],sync_sources:[],index:e+2,parent_message_uuid:Z.wZ}];return(0,Z.vv)(t,s)}),await l({prompt:n,attachments:i,files:o,syncSources:a,rethrowErrors:r,modelOverride:u,parent_message_uuid:c,personalized_style:d})},[l,s,t]);return{...r,runStream:u}}function X(t,e,n,i){let{onIncrementalCompletion:s,onStreamCompleted:a,onStartAppend:r}=(0,F.p)(),l=te({conversationUUID:t,endpoint:o.RETRY_MESSAGE_WITH_COMPLETION,onIncrementalCompletion:s,onInvokeTool:e,onStreamCompleted:a,getTools:n}),{runStream:u}=l,c=(0,M.useCallback)(async(e,n)=>{await r(t,t=>{let n=[{uuid:Z.FC,content:[],created_at:new Date().toISOString(),sender:"assistant",attachments:[],files:[],files_v2:[],sync_sources:[],parent_message_uuid:e,selectedOption:0,index:(0,Z.HX)(t)+1}];return(0,Z.vv)(t,n)}),await u({prompt:"",attachments:[],files:[],syncSources:[],parent_message_uuid:e,personalized_style:i,paprika_mode:n,isRetry:!0})},[t,u,r,i]);return{...l,runStream:c}}let q="incomplete_stream",$=t=>{var e,n;let i=K(t),{config:s}=(0,O.useExperiment)("tepui_default_on_claude_free"),o=null==s?void 0:null===(e=s.get("console_default_model_override",null))||void 0===e?void 0:e.model,{layer:a}=(0,O.useLayer)("frontend"),r=null===(n=a.get("console_default_model_override",null))||void 0===n?void 0:n.model,{config:l}=(0,O.useConfig)("console_default_model"),u=l.get("model",null);return i||o||r||u||"claude-2.1"},K=t=>{let e=(0,l.cE)(t||""),n=(0,E.useSearchParams)(),i=null==n?void 0:n.get("model");return(null==e?void 0:e.model)?null==e?void 0:e.model:i||void 0},V={value:null},tt=()=>{let t=(0,C.useQueryClient)();return{failedStreamRetryData:(0,w.useQuery)({queryKey:[v.sf],queryFn:()=>V.value,initialData:null}).data||null,setFailedStreamRetryData:(0,M.useCallback)(e=>{V.value=e,t.setQueryData([v.sf],e)},[t])}};function te(t){var e;let{conversationUUID:n,endpoint:i,getTools:s,onIncrementalCompletion:o,onInvokeTool:a,onStreamCompleted:v}=t,{applicationType:C}=(0,d.m)(),{activeOrganization:w}=(0,h.t)(),{value:L}=(0,k.F)("apps_no_smoothing"),I=null==w?void 0:w.uuid,{getRemoteMcpTools:N}=(0,_.$)(),{value:D}=(0,k.F)("apps_use_new_smoother"),{context:P,clearContext:B,setContext:z}=function(t){let[e,n]=(0,M.useContext)(U),[i,s]=(0,M.useState)(),o=(0,M.useCallback)(()=>{n?n(e=>{let n={...e};return delete n[t],n}):s(void 0)},[t,n]),a=(0,M.useCallback)(e=>{n?n(n=>({...n,[t]:e})):s(e)},[t,n]);return{context:e?e[t]:i,clearContext:o,setContext:a}}(n),R=(0,E.useSearchParams)(),H=null==R?void 0:R.get("t"),Z=(0,y.zO)(),F=null!==(e=K(n))&&void 0!==e?e:"",Y=null==R?void 0:R.get("max_tokens"),G=(0,W.n)(),{addError:X,clearToast:$}=(0,p.e)(),V=(0,M.useMemo)(x.H,[]),te=(0,l.$H)("push",V),{setFailedStreamRetryData:tn}=tt(),ti=(0,M.useCallback)(async t=>{await (null==v?void 0:v(n,t)),B()},[v,n,B]),ts=(0,M.useCallback)((t,e,i)=>{if(t===q)return X((0,r.jsx)("p",{children:(0,r.jsx)(T.Z,{defaultMessage:"Claude’s response was interrupted. Please check your network connection or <link>contact support</link> if the issue persists.",id:"C83ex9tIjX",values:{link:t=>(0,r.jsx)(j.default,{href:"https://support.anthropic.com/en/articles/9015913-how-to-get-support",className:"underline",children:t})}})}));if(!(t instanceof m.Hx))return X((0,r.jsx)(T.Z,{defaultMessage:"We couldn’t connect to Claude. Please check your network connection and try again.",id:"KzO0j4cGtg"}));if("rate_limit_error"===t.type){if(t.message.includes("{")&&I)try{let e=JSON.parse(t.message);G(e,I,n)}catch(t){}return X((0,r.jsxs)("p",{children:[(0,r.jsx)(T.Z,{defaultMessage:"You’ve reached the limit for Claude messages at this time. Please wait before trying again.",id:"CBMEJMlMzs"}),"\xa0",(0,r.jsx)(u.o,{})]}))}if("not_found_error"===t.type)return X((0,r.jsx)(T.Z,{defaultMessage:"Claude model version not found.",id:"kdrUaXpTqd"}));if("billing_error"===t.type)return X((0,r.jsx)("p",{children:(0,r.jsx)(T.Z,{defaultMessage:"We had an unexpected billing error, please <link>contact support.</link>",id:"MBYn4HHrFu",values:{link:t=>(0,r.jsx)("a",{className:"underline",href:"https://support.anthropic.com/en/articles/9015913-how-can-i-contact-support",target:"_blank",rel:"noreferrer",children:t})}})}));if("overloaded_error"===t.type)return X((0,r.jsxs)("p",{children:[(0,r.jsx)(T.Z,{defaultMessage:"Due to unexpected capacity constraints, Claude is unable to respond to your message. Please try again soon.",id:"TRpxX8Mu1L"}),(0,r.jsx)(u.o,{})]}));if("exceeded_max_uploads_per_message"===t.errorCode){X((0,r.jsx)(T.Z,{defaultMessage:"Your message will exceed the maximum number of files allowed per message. Consider removing some of your files or adding files over several messages.",id:"/jNwaAHdg9"}));return}if("exceeded_max_image_limit_per_chat"===t.errorCode){let t=X((0,r.jsx)("p",{children:i>0?(0,r.jsx)(T.Z,{defaultMessage:"Your message will exceed the <link>maximum image count</link> for this chat. Try uploading {count, plural, one {# document} other {# documents}} with fewer pages, removing images, <newChatLink>or starting a new conversation.</newChatLink>{upgradeInstructions}",id:"gltmHPfviz",values:{link:t=>(0,r.jsx)("a",{className:"underline",target:"_blank",rel:"noreferrer",href:g._R,children:t}),newChatLink:e=>(0,r.jsx)("a",{href:"#",className:"underline",onClick:e=>{e.preventDefault(),te(),$(t)},children:e}),upgradeInstructions:()=>(0,r.jsx)(u.o,{}),count:i}}):(0,r.jsx)(T.Z,{defaultMessage:"Your message will exceed the <link>maximum image count</link> for this chat. Try removing images <newChatLink>or starting a new conversation.</newChatLink>{upgradeInstructions}",id:"QmLhKBubcc",values:{link:t=>(0,r.jsx)("a",{className:"underline",target:"_blank",rel:"noreferrer",href:g._R,children:t}),newChatLink:e=>(0,r.jsx)("a",{href:"#",className:"underline",onClick:e=>{e.preventDefault(),te(),$(t)},children:e}),upgradeInstructions:()=>(0,r.jsx)(u.o,{})}})}));return}if("invalid_request_error"===t.type&&413===t.statusCode){let t=X((0,r.jsx)("p",{children:e>0?(0,r.jsx)(T.Z,{defaultMessage:"Your message will exceed the <link>length limit</link> for this chat. Try attaching fewer or smaller files <newChatLink>or starting a new conversation.</newChatLink>{upgradeInstructions}",id:"G1lejdsk5p",values:{link:t=>(0,r.jsx)("a",{className:"underline",target:"_blank",rel:"noreferrer",href:g.jC,children:t}),newChatLink:e=>(0,r.jsx)("a",{href:"#",className:"underline",onClick:e=>{e.preventDefault(),te(),$(t)},children:e}),upgradeInstructions:()=>(0,r.jsx)(u.o,{})}}):(0,r.jsx)(T.Z,{defaultMessage:"Your message will exceed the <link>length limit</link> for this chat. Try shortening your message <newChatLink>or starting a new conversation.</newChatLink>{upgradeInstructions}",id:"EWtBrIlAAR",values:{link:t=>(0,r.jsx)("a",{className:"underline",target:"_blank",rel:"noreferrer",href:g.jC,children:t}),newChatLink:e=>(0,r.jsx)("a",{href:"#",className:"underline",onClick:e=>{e.preventDefault(),te(),$(t)},children:e}),upgradeInstructions:()=>(0,r.jsx)(u.o,{})}})}));return}return"invalid_request_error"===t.type&&"read_only_mode"===t.extra.code?X((0,r.jsx)("p",{children:(0,r.jsx)(T.Z,{defaultMessage:"Due to capacity constraints, chatting with Claude is currently not available. Please try again in a little while.",id:"W2dIBW8oIg"})})):X(t)},[X,I,G,n,te,$]),to=(0,c.z$)(),ta=function(){let{height:t,width:e}=(0,J.iP)(),n=[];return n.length?n.join("\n"):null}(),{config:tr}=(0,O.useExperiment)("no_more_smoother"),tl=(0,M.useCallback)(async t=>{let{prompt:e,attachments:r,files:l,syncSources:u,rethrowErrors:c=!1,modelOverride:d,parent_message_uuid:h,personalized_style:p,isRetry:_=!1,paprika_mode:m}=t;if(P)return;if(!w)throw Error("Cannot stream without an organization");let g=new AbortController;z({controller:g}),tn(null);let k={prompt:e,parent_message_uuid:h,timezone:S.ou.local().zoneName||void 0,personalized_styles:p?[p]:void 0},v=(0,A.l)();(v||ta)&&(k.custom_system_prompt=[v,ta].filter(Boolean).join("\n")),F&&"string"==typeof F&&(k.model=F),d&&(k.model=d),"string"==typeof H&&(k.temperature=parseInt(H)),Y&&"string"==typeof Y&&(k.max_tokens_to_sample=parseInt(Y)),_&&m&&(k.paprika_mode=m);let y=s();y.length&&(k.tools=y);let x=N();x.length>0&&(k.tools=[...y,...x]);let j=[],E=null,M=null,T=null;try{let t=tr.get("no_smoothing",!1);E=(T=await Q({applicationType:C,endpoint:i,orgUuid:w.uuid,conversationUuid:n,body:{organization_uuid:w.uuid,conversation_uuid:n,text:e,attachments:r,files:l.map(t=>t.file_uuid),sync_sources:u.map(t=>t.uuid)},onCompletion:t=>{o(n,t),j=t},onInvokeTool:a,abortController:g,completion:k,getTools:s,smoothingEnabled:!L&&!t,shouldUseNewSmoother:D,redactedStrings:Z})).stopReason,M=T.messageLimitResult}catch(t){if(tn({prompt:e,attachments:r,files:l}),ts(t,r.length+l.length,l.filter(t=>"document"===t.file_kind).length),(0,b.Tb)(t),c||(0,f.yG)())throw t}finally{T&&!E&&(o(n,j),ts(q,r.length+l.length,l.filter(t=>"document"===t.file_kind).length),to.track({event_key:"sse_interrupted"}),(0,b.uT)("sse_interrupted"),await new Promise(t=>setTimeout(t,3e4))),await ti(M)}return j},[P,w,z,tn,ta,F,H,Y,s,N,tr,C,i,n,a,L,D,Z,o,ts,ti,to]),tu=(0,M.useCallback)(()=>{P&&(P.controller.abort(),ti(null))},[P,ti]);return{runStream:tl,isStreaming:!!P,abortStream:tu}}},78230:function(t,e,n){n.d(e,{h:function(){return o},l:function(){return a}});var i=n(7653);let s="customSystemPrompt",o=()=>{let[t,e]=(0,i.useState)(()=>"undefined"==typeof localStorage?"":localStorage.getItem(s)||"");return(0,i.useEffect)(()=>{localStorage.setItem(s,t)},[t]),{customSystemPrompt:t,setCustomSystemPrompt:e}},a=()=>"undefined"==typeof localStorage?"":localStorage.getItem(s)},49185:function(t,e,n){n.d(e,{I:function(){return u},n:function(){return l}});var i=n(5362),s=n(27218),o=n(13262),a=n(77930),r=n(7653);let l=()=>{let t=(0,a.useQueryClient)();return(0,r.useCallback)((e,n,i)=>{"within_limit"!==e.type&&(e.conversationUUID=i),t.setQueryData([o.aY],t=>t?{...t,messageLimits:{...t.messageLimits,[n]:e}}:t)},[t])},u=t=>{let{activeOrganization:e}=(0,s.t)(),n=null==e?void 0:e.uuid,o=l(),a={type:"within_limit"};return(0,i.uC)(()=>"/api/organizations/".concat(n,"/reset_rate_limits"),"POST",{onSuccess:()=>{o(a,n,t||"")},meta:{noToast:!0}})}},57271:function(t,e,n){n.d(e,{p:function(){return u}});var i=n(27218),s=n(13262),o=n(77930),a=n(7653),r=n(1146),l=n(49185);let u=()=>{let t=(0,o.useQueryClient)(),{activeOrganization:e}=(0,i.t)(),n=null==e?void 0:e.uuid,u=(0,a.useRef)(),c=(0,l.n)(),d=(0,a.useCallback)(async(e,i)=>{let o=[s.I8,{orgUUID:n},{uuid:e}],a=t.getQueryData(o);if(!a)throw Error("Conversation tree must be provided for append");let r=i(a);u.current=r,await t.cancelQueries({queryKey:o}),t.setQueryData(o,u.current)},[t,n]),h=(0,a.useCallback)((e,i)=>{0!==i.length&&t.setQueryData([s.I8,{orgUUID:n},{uuid:e}],()=>{let t=u.current;if(!t)throw Error("Conversation tree must be provided for incremental completion");if(!t.current_leaf_message_uuid)throw Error("Couldn't figure out where to put completion");let e=t.messageByUuid.get(t.current_leaf_message_uuid);if(!e)throw Error("New assistant message not found");return e.content=i,{...t,created_at:new Date().toISOString()}})},[t,n]);return{onStartAppend:d,onStreamCompleted:(0,a.useCallback)(async(e,i)=>{let o=[s.I8,{orgUUID:n},{uuid:e}];u.current=void 0,i?(t.setQueryData([s.tv,{orgUUID:n}],t=>{if(!t)return;let n=t.find(t=>t.uuid===e);return n?[{...n,updated_at:new Date().toISOString()},...t.filter(t=>t.uuid!==e)]:t}),await t.invalidateQueries({queryKey:o})):t.invalidateQueries({queryKey:o}),i&&n&&c(i,n,e)},[t,c,n]),onIncrementalCompletion:h,changeDisplayedConversationPath:(0,a.useCallback)((e,i,o,a)=>{t.setQueryData([s.I8,{orgUUID:n},{uuid:e}],t=>{if(!t)throw Error("Conversation tree must be provided for changeDisplayedConversationPath");let e=(0,r.mj)(t,i,o);return e.current_leaf_message_uuid&&a&&a(e.current_leaf_message_uuid),e})},[t,n])}}},66092:function(t,e,n){n.d(e,{$:function(){return o}});var i=n(7653),s=n(18013);function o(){let[t,e]=(0,s.R)("mcp-enabled-tools",{}),n=(0,i.useCallback)((t,n)=>{e(e=>({...e,[t]:n}))},[e]),o=(0,i.useCallback)(e=>!!t[e],[t]),a=(0,i.useCallback)(()=>{let e=Object.entries(t).filter(t=>{let[e,n]=t;return n}).map(t=>{let[e]=t;return e});return 0===e.length?[]:e.map(t=>({type:"remote_mcp_v0",name:t}))},[t]);return{enabledTools:t,setEnabledTools:e,toggleTool:n,isToolEnabled:o,getRemoteMcpTools:a}}},66894:function(t,e,n){n.d(e,{Ry:function(){return o},cm:function(){return s},yG:function(){return i}}),n(68571);let i=()=>!1,s=()=>!1,o=()=>s()||i()},91598:function(t,e,n){n.d(e,{fs:function(){return a},lR:function(){return o},zO:function(){return r}});var i=n(7653),s=n(15992);let o="echo_forest_path",a="dream_circuit_wave";function r(){let t=(0,s.useConfig)("apps_redacted_strings_paprika"),e=(0,s.useConfig)("apps_redacted_strings_sherlock");return(0,i.useMemo)(()=>({...t.config.value,...e.config.value}),[e.config.value,t.config.value])}}}]);